# Instructions for Reproducing Analyses
**Last Updated: 10 Nov 2023**

Any difficulties reproducing the analysis, please contact the corresponding author, [Messi H.J. Lee](mailto:hojunlee@wustl.edu). 


## Guide to the Repository Folders (in Alphabetical Order)

- Data
     - Folder containing text generated to replace non-compliant completions (**Extra**)
     - All texts generated by ChatGPT as a .csv file (**generated_text_final.csv**)
     - Code used to identify non-compliant completions and to merge all completions (**merge_texts.R**)
     - Folder containing texts generated at initial round of data collection (**Original**)

* BERT-2
     * Code used to conduct pre-registered analysis using mixed-effects models (**bert2.R**)

- Pre-Registration
     - Pre-registration documentation for the project (**Pre-Registration for The Effect of Group Status on the Variability of Group Representations in LLM-generated Text.docx**)
     - Documentation of vignettes used for data collection (**Vignettes for The Effect of Group Status on the Variability of Group Representations in LLM-generated Text.docx**)

* BERT-3
     * Code used to conduct robustness checks using third to last layer of BERT (**bert3.R**)

- RoBERTa-2
     - Code used to conduct robustness checks using second to last layer of RoBERTa (**roberta2.R**)

* RoBERTa-3
     * Code used to conduct robustness checks using third to last layer of RoBERTa (**roberta3.R**)

- Sentence-BERT
     - Code used to generate sentence embeddings using Sentence-BERT models (**sentence_bert.ipynb**)
     - Code used to conduct robustness checks using using Sentence-BERT (**sentence_bert.R**)

* Supplement.Preprocessing
     * Code used to test robustness of results to the pre-processing steps used on the generated text (**s5_preprocessing_mixed_effects.R**)

## Data Availability Statement

All code and data required for reproducing analyses are available in the repository.

## Before You Begin: Install the following packages

- R Packages (R version used: 4.2.3). If R is not installed, download [a version of R](https://cran.r-project.org/).
     - tidyverse: https://cran.r-project.org/web/packages/tidyverse/index.html
     - text: https://cran.r-project.org/web/packages/text/index.html
     - text2vec: https://cran.r-project.org/web/packages/text2vec/index.html
     - lme4: https://cran.r-project.org/web/packages/lme4/index.html
     - lmerTest: https://cran.r-project.org/web/packages/lmerTest/index.html
     - afex: https://cran.r-project.org/web/packages/afex/index.html
     - emmeans: https://cran.r-project.org/web/packages/emmeans/index.html
     - psych: https://cran.r-project.org/web/packages/psych/index.html
     - arrow: https://cran.r-project.org/web/packages/arrow/index.html

* Python Packages (Python version used: 3.11.4). If Python 3 is not installed, download [a version of Python 3](https://www.python.org/downloads/).
     * openai: https://pypi.org/project/openai/
     * tqdm: https://pypi.org/project/tqdm/
     * numpy: https://pypi.org/project/numpy/
     * pandas: https://pypi.org/project/pandas/
     * torch: https://pypi.org/project/torch/
     * sentence-transformers: https://pypi.org/project/sentence-transformers/
     * feather: https://pypi.org/project/feather/

## Workflow for Reproducing Analyses in the Main Text

### Collect ChatGPT-generated text using OpenAI API (Data Folder)
> **Initial Round of Data Collection (Data/Original)**
* Execute "generate_text.py” inside the "Original" subfolder of the "Data" folder. 
     - Enter your OpenAI API Key in line 10. 
     - Modify lines 26 and 69 to match the batch of texts being collected. In the first three rounds, set *num_iter* to 128 (the max value) and in the fourth round, set *num_iter* to 116. Modify .csv file name to match batch number. 
     - This code uses the OpenAI API to generate texts using the pre-defined vignettes (writing prompts) and saves them as .csv files inside the "Original" subfolder of the "Data" folder. 

> **Merge Collected Data into a Single .csv File (Data)**
* Open "merge_texts.R" using an IDE of your choice (we use RStudio). 
     - Depending on your data, you may have to define your own set of expressions to use to identify non-compliant completions. You can find the same set of expressions we used in the R file. 
     - Newly collected data will be different from the ones that we collected. Hence, you will have to tabulate the non-compliant completions that you get in your data. 
     - Once you get to line 45 of "merge_texts.R", you will have to generate new text to replace the non-compliant ones.

- Open "generate_extra_1.py" using an IDE of your choice (we use VSCode).
     * Enter your OpenAI API Key in line 10. 
     * Using the non-compliant completions that you tabulated, fill out each of *race_list*, *format_list*, and *gender_list* so that extra text is generated for the tabulated vignettes. 
     * Execute "generate_extra_1.py” inside the "Extra" subfolder of the "Data" folder. 
     * This code uses the OpenAI API to generate texts using the tabulated vignettes and saves them as a .csv file inside the "Extra" subfolder of the "Data" folder. 

* Go back to "merge_texts.R".
     - Again, tabulate the non-compliant completions inside the newly generated text. If you identify additional non-compliant completions, repeat the step above until there are 0 non-compliant completions. 
     - Once you have a complete data set of 52,000 texts, save it as *generated_text_final.csv* inside the "Data" folder. 


### Mixed Effects Models
> Mixed Effects Model using BERT<sub>-2</sub> (BERT-2 Folder)
* Open "bert2.R" using an IDE of your choice (we use RStudio). 
* This code generates sentence embeddings using the second to last layer of BERT, calculates the cosine similarity between pairs of sentence embeddings within individual writing prompts, and fits two single fixed effect mixed effects models and a mixed effect model including the interaction term. 

> Mixed Effects Model using BERT<sub>-3</sub> (BERT-3 Folder)
* Open "bert3.R" using an IDE of your choice (we use RStudio). 
* This code generates sentence embeddings using the third to last layer of BERT, calculates the cosine similarity between pairs of sentence embeddings within individual writing prompts, and fits two single fixed effect mixed effects models and a mixed effect model including the interaction term. 

> Mixed Effects Model using RoBERTa<sub>-2</sub> (RoBERTa-2 Folder)
* Open "roberta2.R" using an IDE of your choice (we use RStudio). 
* This code generates sentence embeddings using the second to last layer of RoBERTa, calculates the cosine similarity between pairs of sentence embeddings within individual writing prompts, and fits two single fixed effect mixed effects models and a mixed effect model including the interaction term. 

> Mixed Effects Model using RoBERTa<sub>-3</sub> (Roberta-3 Folder)
* Open "roberta3.R" using an IDE of your choice (we use RStudio). 
* This code generates sentence embeddings using the third to last layer of RoBERTa, calculates the cosine similarity between pairs of sentence embeddings within individual writing prompts, and fits two single fixed effect mixed effects models and a mixed effect model including the interaction term. 

> Mixed Effects Model using Sentence-BERT Models (Sentence-BERT Folder)
* Open "sentence_bert.R" using an IDE of your choice (we use RStudio). 
* This code generates sentence embeddings using three different Sentence-BERT models, calculates the cosine similarity between pairs of sentence embeddings within individual writing prompts, and fits two single fixed effect mixed effects models and a mixed effect model including the interaction term. 

> Mixed Effects Model using Extra Pre-processing Steps (Supplement.Preprocessing Folder)
* Open "preprocessing.R" using an IDE of your choice (we use RStudio). 
* This code generates sentence embeddings using the second to last layer of BERT having performed additional pre-processing steps on the data, calculates the cosine similarity between pairs of sentence embeddings within individual writing prompts, and fits two single fixed effect mixed effects models and a mixed effect model including the interaction term. 